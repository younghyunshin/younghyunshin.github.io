---
layout: post
title: "iOS) 메모리구조 - Code, Data, Stack, Heap"
tags: [iOS, Swift]
comments: true
---

> 메모리 구조 이해하기  

⚠ iOS알못의 글이므로 틀린 정보가 있을 수 있습니다.  

운영체제 시간에 배운 코드, 데이터, 스택, 힙 영역.. 정말 중요한 개념이기에 복습할 겸 지금 공부하고 있는 iOS와 연결지어 생각해보려한다. 프로그램을 실행하면 OS는 프로그램에게 메모리 영역을 할당해주는데 그 메모리 영역이 코드, 데이터, 스택, 힙 영역으로 나뉘어져있다. 그리고 이 각 영역에 저장되는 데이터의 종류가 다르다. 아래 그림을 보면 이런 차이점을 확인할 수 있다. 각각의 영역에 대해 좀 더 자세히 살펴보자.

![1](https://user-images.githubusercontent.com/35067611/105793085-d9ae2300-5fcb-11eb-824d-7d389fc2db29.png)

## Code

코드 영역은 이름처럼 직관적이다. 프로그래머가 작성한 `소스코드`가 0과 1, binary 형태로 저장되는 공간으로 텍트스 영역이라고도 불린다. 당연히 프로그램 실행 중 코드가 바뀌면 안되니 Read-Only로 저장된다. CPU는 코드 영역에 저장된 명령어를 하나씩 가져가서 처리한다.

## Data

메모리의 데이터(data) 영역은 프로그램의 `전역 변수`와 `정적(static) 변수`가 저장되는 영역이다. 데이터 영역은 프로그램의 시작과 함께 할당되며, 프로그램이 종료되면 소멸한다.

```swift
struct Korean {
	// 정적(static) 변수로 데이터 영역에 할당
	static let country = "Korea"
}

// 전역변수로 데이터 영역에 할당
var name: String?
var age: Int?
```

## Stack

스택영역은 함수의 호출과 관계되는 `지역변수`와 `매개변수`가 저장되는 영역이다. 함수의 호출과 함께 할당되며 함수의 호출이 완료되면 소멸한다. 이렇게 스택영역에 저장되는 함수의 호출정보를 스택 프레임(stack frame)이라고 한다. 스택은 LIFO 방식으로 작동하므로 가장 늦게 저장된 데이터가 먼저 pop 된다. 스택영역은 CPU에 의해 관리되고 최적화 돼서 속도가 매우 빠르다는 장점이 있다.

*스택 영역은 메모리의 높은 주소 → 낮은 주소 방향으로 할당된다.

```swift
func add(a: Int, b: Int) -> Int {    // 매개변수 a, b 스택영역에 할당
    let result = a + b               // 지역변수 result 스택영역에 할당
    return result
}
```

## Heap

메모리의 힙(heap) 영역은 사용자가 직접 관리할 수 있는, 그리고 해야만 하는 메모리 영역이다. 힙 영역은 사용자에 의해 메모리 공간이 `동적으로 할당되고 해제`된다.

*힙 영역은 메모리의 낮은 주소 → 높은 주소의 방향으로 할당된다.

```swift
class Person {
    var name: String?
    var age: Int?
}

var person: Person = Person()    // 클래스 인스턴스는 힙, person 변수는 스택 영역에 할당
```

## 비교

**Code & Data vs. Stack & Heap**

- Code, Data 영역은 메모리 사용량에 `변동이 없다`. 앱이 실행되는 동안에 Xcode 상에서 작성한 코드와 변수들이 변할 일은 그냥 없다고 보면 된다. 앱이 종료될 시에 이 부분은 메모리에서 해제된다.
- 반대로 Stack, Heap 영역은 `가변적`이다. 스택이나 힙 영역이 거대해져 서로의 영역을 침범할 수 있다. 이 때 스택이 힙을 침범하는 것을 스택 오버플로우(Stack Overflow), 반대의 경우를 힙 오버플로우(Heap Overflow)라고 한다.  예를들면 for 문을 무한히 돌리게 되면 스택 오버플로우가 발생하게 될 것이고, ARC 에 의해서 관리되지 못한 강한 순환 참조와 같은 문제들로 인해서 힙 오버플로우 현상이 발생할 수 있다.

**Stack vs. Heap**

- 스택영역은 CPU가 효율적으로 메모리를 구성하기에 최적화가 되어있어 속도가 빠르고 메모리를 직접 해제하지 않아도 된다. 반면 힙 영역은 메모리를 개발자가 직접 관리해야하므로 메모리 누수의 위험성이 있고 할당/해제 작업으로 인해 속도가 스택에 비해 느리다.
- 스택영역은 메모리 크기에 대한 제한이 있지만 힙 영역은 메모리 크기에 대한 제한이 없다.

## 정리

- 코드 : 소스코드. Read-Only
- 데이터 : 전역변수, 정적변수.
- 스택 : 매개변수, 지역변수.
- 힙 : 동적할당, 해제. 유일하게 런타임 시점에 결정되는 영역

## References

[소들이님 블로그 - iOS) 메모리 구조 (Code, Data, Stack, Heap)](https://babbab2.tistory.com/25)

[코딩교육 티씨피스쿨](http://tcpschool.com/c/c_memory_structure)
